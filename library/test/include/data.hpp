#include <mbsm.hpp>

mbsm::candidates::Signature<> expected_query_signatures[]{// Graph 1
                                                          {0b0000000000000000000000000000000000000000000001110000000000000000},
                                                          {0b0000000000000000000000000000000000000000000000110000000000000000},
                                                          {0b0000000000000000000000000000000000000000000000110000000000000000},
                                                          {0b0000000000000000000000000000000000000000000001100000000000010000},
                                                          {0b0000000000000000000000000000000000000000000000110000000000010000},
                                                          {0b0000000000000000000000000000000000000000000000010000000000010000},
                                                          // Graph 2
                                                          {0b0000000000000000000000000000010000000010000000000000000000100000},
                                                          {0b0000000000000000000000000000000100000010000000000000000000100000},
                                                          {0b0000000000000000000000000000000100000010000000000000000000100000},
                                                          {0b0000000000000000000000000000000100000010000000000000000000100000},
                                                          {0b0000000000000000000000000000000100000010000000000000000000100000},
                                                          // Graph 3
                                                          {0b0000000000000000000000000000000000000000000100000000000000010000},
                                                          {0b0000000000000000000000000000000000000000000100000000000000110000},
                                                          {0b0000000000000000000000000000000000000000000100000000000000110000},
                                                          {0b0000000000000000000000000000000000000000000000000000000001100000},
                                                          {0b0000000000000000000000000000000000000000000000000000000001100000},
                                                          {0b0000000000000000000000000000000000000000000000000000000001100000},
                                                          {0b0000000000000000000000000000000000000000000000000000000001100000},
                                                          {0b0000000000000000000000000000000000000001000000000000000000110000},
                                                          {0b0000000000000000000000000000000000000001000000000000000000110000},
                                                          {0b0000000000000000000000000000000000000001000000000000000000010000}};

mbsm::candidates::Signature<> expected_data_signatures[]{// Graph 1
                                                         {0b0000000000000000000000010000000000000000000000110000000000000000},
                                                         {0b0000000000000000000000010000000000000000000001110000000000000000},
                                                         {0b0000000000000000000000010000000000000000000101100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000001001100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000001001110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000110100000000000000000},
                                                         {0b0000000000000000000000000000000000000000001001100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000001110000000000000000},
                                                         {0b0000000000000000000000000001000000000000000001100000000000000000},
                                                         {0b0000000000000000000000000001000000000000000001110000000000000000},
                                                         {0b0000000000000000000000000001000000000000000000110000000000000000},
                                                         {0b0000000000000000000000000001000000000000000001100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000001100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000100010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000100010000000000000000},
                                                         {0b0000000000000000000000000000000000000000001001110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000001110000000000000000},
                                                         {0b0000000000000000000000010000000000000000000001100000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001100000000000000000},
                                                         {0b0000000000000000000000000000000000000010000000100000000000000000},
                                                         {0b0000000000000000000000000000000000000001000000100000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101100000000000000000},
                                                         // Graph 2
                                                         {0b0000000000000000000000000000000000000001000100010000000000000000},
                                                         {0b0000000000000000000000000000000000000001000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000001001101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000001001001110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000100010000000000000000},
                                                         {0b0000000000000000000000000000000000000001001000100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000001101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000001101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000001100100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000000010100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000001100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000001000100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000001000101100000000000000000},
                                                         // Graph 3
                                                         {0b0000000000000000000000000000001000000000000000110000000000000000},
                                                         {0b0000000000000000000000000000000100000000000001110000000000000000},
                                                         {0b0000000000000000000000000000000100000000000001100000000000000000},
                                                         {0b0000000000000000000000000000000100000000000000110000000000000000},
                                                         {0b0000000000000000000000000000000100000000000001010000000000000000},
                                                         {0b0000000000000000000000000000000100000000000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001100000000000000000},
                                                         {0b0000000000000000000000000000000000000001000000110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000000001001100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101100000000000000000},
                                                         {0b0000000000000000000000000000000000000010000101110000000000000000},
                                                         {0b0000000000000000000000000000000000000010000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000010000000010000000000000000},
                                                         {0b0000000000000000000000000000000000000011000000100000000000000000},
                                                         {0b0000000000000000000000000000000100000001000000110000000000000000},
                                                         {0b0000000000000000000000000000000100000001000000110000000000000000},
                                                         {0b0000000000000000000000000000001000000000000000100000000000000000},
                                                         {0b0000000000000000000000000000000100000000000000110000000000000000},
                                                         {0b0000000000000000000000000000000100000000000000010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000010110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001100000000000000000},
                                                         {0b0000000000000000000000000000000000000011000000100000000000000000},
                                                         {0b0000000000000000000000000000000000000010000001000000000000000000},
                                                         {0b0000000000000000000000000000000000000011000000100000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001100000000000000000},
                                                         {0b0000000000000000000000000000000000000001000001100000000000000000},
                                                         {0b0000000000000000000000000000000000000000000001110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101110000000000000000},
                                                         // Graph 4
                                                         {0b0000000000000000000000000000010100000010000100010000000000000000},
                                                         {0b0000000000000000000000000000000100000010000100010000000000000000},
                                                         {0b0000000000000000000000000000000100000010000100010000000000000000},
                                                         {0b0000000000000000000000000000000100000010000100010000000000000000},
                                                         {0b0000000000000000000000000000001000000010001101000000000000000000},
                                                         {0b0000000000000000000000000000001100000000001100100000000000000000},
                                                         {0b0000000000000000000000000000000100000000001101010000000000000000},
                                                         {0b0000000000000000000000000000000100000000001100010000000000000000},
                                                         {0b0000000000000000000000000000001000000000001100010000000000000000},
                                                         {0b0000000000000000000000000000000100000001001100110000000000000000},
                                                         {0b0000000000000000000000000000000000000001000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000001000100010000000000000000},
                                                         {0b0000000000000000000000000000000000000001000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000001100110000000000000000},
                                                         {0b0000000000000000000000000000000000000010000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000010000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000010000000010000000000000000},
                                                         {0b0000000000000000000000000000000000000010000000010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000001100110000000000000000},
                                                         {0b0000000000000000000000000000000000000010000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000010000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000010000000010000000000000000},
                                                         {0b0000000000000000000000000000000000000010000000010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000000001100110000000000000000},
                                                         {0b0000000000000000000000000000000000000010000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000010000100110000000000000000},
                                                         {0b0000000000000000000000000000000000000010000000010000000000000000},
                                                         {0b0000000000000000000000000000000000000010000000010000000000000000},
                                                         {0b0000000000000000000000000000000000000001000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000001000101010000000000000000},
                                                         {0b0000000000000000000000000000000000000001000100010000000000000000},
                                                         {0b0000000000000000000000000000000100000001001100110000000000000000},
                                                         {0b0000000000000000000000000000000100000000001101010000000000000000},
                                                         {0b0000000000000000000000000000001100000000001100100000000000000000},
                                                         {0b0000000000000000000000000000001000000010001101000000000000000000},
                                                         {0b0000000000000000000000000000010100000010000100010000000000000000},
                                                         {0b0000000000000000000000000000000100000010000100010000000000000000},
                                                         {0b0000000000000000000000000000000100000010000100010000000000000000},
                                                         {0b0000000000000000000000000000000100000010000100010000000000000000},
                                                         {0b0000000000000000000000000000001000000000001100010000000000000000},
                                                         {0b0000000000000000000000000000000100000000001100010000000000000000},
                                                         // Graph 5
                                                         {0b0000000000000000000000000000000000000000000000000000000000110000},
                                                         {0b0000000000000000000000000000000000000000000000000000000000110000},
                                                         {0b0000000000000000000000000000000000000000000000000000000000110000},
                                                         {0b0000000000000000000000000000000000000000000000000000000000110000}};

std::vector<mbsm::candidates::Signature<>> getExpectedDataSignatures(std::string fname, size_t refinement_steps = 1) {
  auto data = mbsm::io::loadDataGraphsFromFile(fname);

  size_t num_nodes = 0;
  for (auto& graph : data) { num_nodes += graph.getNumNodes(); }

  std::vector<mbsm::candidates::Signature<>> signatures(num_nodes);

  size_t offset = 0;

  for (auto& graph : data) {
    for (int i = 0; i < graph.getNumNodes(); ++i) {
      auto start_node = graph.getRowOffsets()[i];
      auto end_node = graph.getRowOffsets()[i + 1];

      for (int j = start_node; j < end_node; ++j) {
        auto neighbor = graph.getColumnIndices()[j];
        signatures[offset + i].incrementLabelCount(graph.getLabels()[neighbor]);
      }
    }
    offset += graph.getNumNodes();
  }

  for (int _ = 0; _ < refinement_steps; _++) {
    std::vector<mbsm::candidates::Signature<>> db_signatures(num_nodes);
    std::copy(signatures.begin(), signatures.end(), db_signatures.begin());
    offset = 0;
    for (auto& graph : data) {
      for (int i = 0; i < graph.getNumNodes(); ++i) {
        auto start_node = graph.getRowOffsets()[i];
        auto end_node = graph.getRowOffsets()[i + 1];

        for (int j = start_node; j < end_node; ++j) {
          auto neighbor = graph.getColumnIndices()[j];
          for (int l = 0; l < mbsm::candidates::Signature<>::getMaxLabels(); ++l) {
            auto count = db_signatures[offset + neighbor].getLabelCount(l);
            if (l == graph.getLabels()[i]) { count -= 1; }
            signatures[offset + i].incrementLabelCount(l, count);
          }
        }
      }
      offset += graph.getNumNodes();
    }
  }

  return signatures;
}

std::vector<mbsm::candidates::Signature<>> getExpectedQuerySignatures(std::string fname, size_t refinement_steps = 1) {
  auto data = mbsm::io::loadQueryGraphsFromFile(fname);

  size_t num_nodes = 0;
  for (auto& graph : data) { num_nodes += graph.getNumNodes(); }

  std::vector<mbsm::candidates::Signature<>> signatures(num_nodes);

  size_t offset = 0;

  for (auto& graph : data) {
    for (int i = 0; i < graph.getNumNodes(); ++i) {
      mbsm::types::node_t neighbors[mbsm::types::MAX_NEIGHBORS];

      mbsm::utils::adjacency_matrix::getNeighbors(
          graph.getAdjacencyMatrix(), mbsm::utils::getNumOfAdjacencyIntegers(graph.getNumNodes()), i, neighbors);

      for (int j = 0; neighbors[j] != mbsm::types::NULL_NODE && j < mbsm::types::MAX_NEIGHBORS; ++j) {
        auto neighbor = neighbors[j];
        auto label = graph.getLabels()[neighbor];
        signatures[offset + i].incrementLabelCount(label);
      }
    }
    offset += graph.getNumNodes();
  }

  for (int _ = 0; _ < refinement_steps; _++) {
    std::vector<mbsm::candidates::Signature<>> db_signatures(num_nodes);
    std::copy(signatures.begin(), signatures.end(), db_signatures.begin());
    offset = 0;
    for (auto& graph : data) {
      for (int i = 0; i < graph.getNumNodes(); ++i) {
        mbsm::types::node_t neighbors[mbsm::types::MAX_NEIGHBORS];

        mbsm::utils::adjacency_matrix::getNeighbors(
            graph.getAdjacencyMatrix(), mbsm::utils::getNumOfAdjacencyIntegers(graph.getNumNodes()), i, neighbors);

        for (int j = 0; neighbors[j] != mbsm::types::NULL_NODE && j < mbsm::types::MAX_NEIGHBORS; ++j) {
          auto neighbor = neighbors[j];
          for (int l = 0; l < mbsm::candidates::Signature<>::getMaxLabels(); ++l) {
            auto count = db_signatures[offset + neighbor].getLabelCount(l);
            if (l == graph.getLabels()[i]) { count -= 1; }
            signatures[offset + i].incrementLabelCount(l, count);
          }
        }
      }
      offset += graph.getNumNodes();
    }
  }

  return signatures;
}